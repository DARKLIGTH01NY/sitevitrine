<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zangi Private - Fix</title>
    <style>
        :root { --bg: #0b141a; --sidebar: #111b21; --panel: #202c33; --green: #00a884; --my-msg: #005c4b; }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; display: flex; height: 100vh; }
        #app { display: flex; width: 100%; }
        
        .sidebar { width: 300px; background: var(--sidebar); border-right: 1px solid #222; display: flex; flex-direction: column; }
        .chat-main { flex: 1; display: flex; flex-direction: column; background: #0b141a; }
        
        .contact { padding: 15px; border-bottom: 1px solid #222; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .contact:hover { background: var(--panel); }
        .active { background: var(--panel); border-left: 4px solid var(--green); }

        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 10px; max-width: 70%; font-size: 15px; word-wrap: break-word; }
        .sent { background: var(--my-msg); align-self: flex-end; border-bottom-right-radius: 2px; }
        .received { background: var(--panel); align-self: flex-start; border-bottom-left-radius: 2px; }

        .input-area { padding: 15px; background: var(--panel); display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border-radius: 8px; border: none; background: #2a3942; color: white; outline: none; }
        button { background: var(--green); color: white; border: none; padding: 0 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div id="app">
    <div class="sidebar">
        <div style="padding:15px; background:var(--panel)">
            <a href="index.html" style="color:var(--green); text-decoration:none; font-weight:bold;">← Voltar ao Global</a>
        </div>
        <div id="contacts-list"></div>
    </div>

    <div class="chat-main">
        <div style="padding:15px; background:var(--panel); font-weight:bold;" id="chat-header">Selecione um contato</div>
        <div id="chat-window"></div>
        <div class="input-area">
            <input type="text" id="msg-input" placeholder="Digite uma mensagem..." onkeypress="if(event.key==='Enter') enviar()">
            <button onclick="enviar()" id="btn-envio">Enviar</button>
        </div>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbyc-lO69WKiAHA7DxDZGNejLrfTkAEFSxTUSFdih7emRNRoh0meGAaTafg4kwSwiRJC5g/exec";
    let user = JSON.parse(localStorage.getItem('zangi_user'));
    let target = null;

    if(!user) {
        window.location.href = "index.html";
    }

    async function carregarContatos() {
        try {
            const res = await fetch(`${API}?sheet=contatos`);
            const data = await res.json();
            const meus = data.filter(c => String(c.dono_id) === String(user.id));
            const list = document.getElementById('contacts-list');
            list.innerHTML = meus.map(c => `
                <div class="contact ${target?.id === c.contato_id ? 'active' : ''}" onclick="selecionar('${c.contato_id}', '${c.contato_nome}')">
                    <div style="width:35px; height:35px; background:var(--green); border-radius:50%; text-align:center; line-height:35px; font-weight:bold;">${c.contato_nome[0].toUpperCase()}</div>
                    ${c.contato_nome}
                </div>
            `).join('');
        } catch(e) { console.error("Erro ao carregar contatos:", e); }
    }

    function selecionar(id, nome) {
        target = { id, nome };
        document.getElementById('chat-header').innerText = nome;
        carregarContatos();
        buscarMensagens();
    }

    async function buscarMensagens() {
        if(!target) return;
        try {
            const res = await fetch(`${API}?sheet=messages_privadas`);
            const data = await res.json();
            const win = document.getElementById('chat-window');
            
            const chat = data.filter(m => {
                const de = String(m.de_id || "");
                const para = String(m.para_id || "");
                const eu = String(user.id);
                const alvo = String(target.id);
                return (de === eu && para === alvo) || (de === alvo && para === eu);
            });

            win.innerHTML = chat.map(m => {
                const texto = m.mensagem || "";
                if(!texto.toString().trim()) return ""; 
                return `
                    <div class="msg ${String(m.de_id) === String(user.id) ? 'sent' : 'received'}">
                        ${texto}
                    </div>
                `;
            }).join('');
            win.scrollTop = win.scrollHeight;
        } catch(e) { console.error("Erro ao buscar mensagens:", e); }
    }

    async function enviar() {
        const input = document.getElementById('msg-input');
        const txt = input.value.trim();
        if(!txt || !target) return;

        input.value = ""; // Limpa o campo para feedback visual rápido

        try {
            // Ajuste crucial: Adicionado 'mode: no-cors' e o campo 'sheet' dentro do body
            await fetch(API, {
                method: 'POST',
                mode: 'no-cors',
                cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sheet: "messages_privadas", // Especifica a aba para o Script
                    data: [{
                        de_id: String(user.id),
                        para_id: String(target.id),
                        mensagem: txt,
                        created_at: new Date().toLocaleString('pt-BR')
                    }]
                })
            });
            
            // Pequeno atraso para dar tempo do Google processar antes de recarregar
            setTimeout(buscarMensagens, 500);
        } catch(e) {
            console.error("Erro ao enviar:", e);
        }
    }

    carregarContatos();
    setInterval(buscarMensagens, 4000); // Aumentado para 4s para evitar sobrecarga
</script>
</body>
</html>
